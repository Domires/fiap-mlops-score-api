# üéØ API de Classifica√ß√£o de Score de Cr√©dito

Uma API robusta e inteligente que classifica automaticamente o score de cr√©dito de clientes em tr√™s categorias (**Good**, **Standard**, **Poor**) baseada em caracter√≠sticas financeiras e comportamentais.

## üåü Vis√£o Geral

Esta API utiliza **Machine Learning** para analisar o perfil financeiro de um cliente e determinar seu score de cr√©dito com alta precis√£o. O sistema foi desenvolvido com **MLflow** para versionamento de modelos, **Flask** para servidor web, e **pytest** para testes robustos.

### üéØ O que a API Faz

- **üìä An√°lise Inteligente**: Processa 23+ vari√°veis financeiras do cliente
- **üéØ Classifica√ß√£o Precisa**: Retorna score em 3 categorias com probabilidades
- **üîÑ Auto-Preenchimento**: Preenche campos faltantes com valores inteligentes
- **üõ°Ô∏è Valida√ß√£o Robusta**: Valida e sanitiza todos os dados de entrada
- **üìà Monitoramento**: Coleta m√©tricas para an√°lise de drift de dados
- **üîß M√∫ltiplos Formatos**: Suporta invoca√ß√£o direta e via API Gateway

## üöÄ Quick Start

### 1. **Instala√ß√£o**

```bash
# Clonar reposit√≥rio
git clone <repo-url>
cd api

# Instalar depend√™ncias
pip install -r requirements.txt

# Baixar modelo do MLflow (opcional)
python model_downloader.py
```

### 2. **Subir API como Servidor Web**

```bash
# Op√ß√£o 1: Servidor Flask (Recomendado)
python server.py
```

**üåê API dispon√≠vel em: http://localhost:5000**

```bash
# Op√ß√£o 2: For√ßar uso do MLflow
python run_api_with_mlflow.py
```

### 3. **Testar Funcionamento**

```bash
# Executar todos os testes
python -m pytest tests/ -v

# Demonstra√ß√£o completa
python demo_api.py
```

## üåê Endpoints da API

### **üè† Health Check**
```http
GET http://localhost:5000/
```

**Resposta:**
```json
{
  "status": "healthy",
  "service": "Credit Score API",
  "model": "fiap-mlops-score-model",
  "version": "1.0",
  "source": "mlflow_registry"
}
```

### **üéØ Predi√ß√£o de Score (Principal)**
```http
POST http://localhost:5000/predict
Content-Type: application/json
```

**Payload:**
```json
{
  "data": {
    "Age": 35,
    "Annual_Income": 65000,
    "Monthly_Inhand_Salary": 5200,
    "Num_Bank_Accounts": 2,
    "Num_Credit_Card": 2,
    "Interest_Rate": 11.5,
    "Num_of_Loan": 1,
    "Outstanding_Debt": 8000,
    "Credit_Utilization_Ratio": 28.5,
    "Total_EMI_per_month": 950,
    "Amount_invested_monthly": 800,
    "Monthly_Balance": 3200,
    "Occupation": "Software Engineer",
    "Credit_Mix": "Good",
    "Payment_of_Min_Amount": "No",
    "Payment_Behaviour": "Low_spent_Medium_value_payments"
  }
}
```

**Resposta:**
```json
{
  "prediction": "Good",
  "confidence": 0.85,
  "probabilities": {
    "Good": 0.85,
    "Standard": 0.12,
    "Poor": 0.03
  },
  "model_version": "1.0",
  "model_name": "fiap-mlops-score-model",
  "timestamp": "2025-01-15T10:30:00.123456"
}
```

### **üìã Informa√ß√µes do Endpoint**
```http
GET http://localhost:5000/predict
```

### **üîç Informa√ß√µes do Modelo**
```http
GET http://localhost:5000/model-info
```

## üìä Campos de Entrada

### **Campos Obrigat√≥rios** (Num√©ricos)

| Campo | Tipo | Descri√ß√£o | Exemplo | Faixa |
|-------|------|-----------|---------|-------|
| `Age` | float | Idade do cliente | 35 | 18-100 |
| `Annual_Income` | float | Renda anual (USD) | 65000 | ‚â• 0 |
| `Monthly_Inhand_Salary` | float | Sal√°rio l√≠quido mensal | 5200 | ‚â• 0 |
| `Num_Bank_Accounts` | int | N√∫mero de contas banc√°rias | 2 | ‚â• 0 |
| `Num_Credit_Card` | int | N√∫mero de cart√µes de cr√©dito | 2 | ‚â• 0 |
| `Interest_Rate` | float | Taxa de juros (%) | 11.5 | ‚â• 0 |
| `Num_of_Loan` | int | N√∫mero de empr√©stimos | 1 | ‚â• 0 |
| `Outstanding_Debt` | float | D√≠vida pendente (USD) | 8000 | ‚â• 0 |
| `Credit_Utilization_Ratio` | float | Taxa de utiliza√ß√£o de cr√©dito (%) | 28.5 | 0-100 |
| `Total_EMI_per_month` | float | Total de EMIs mensais | 950 | ‚â• 0 |
| `Amount_invested_monthly` | float | Valor investido mensalmente | 800 | ‚â• 0 |
| `Monthly_Balance` | float | Saldo mensal m√©dio | 3200 | ‚â• 0 |

### **Campos Opcionais** (Categ√≥ricos)

| Campo | Tipo | Valores Aceitos | Padr√£o |
|-------|------|-----------------|--------|
| `Occupation` | string | Qualquer profiss√£o | "Other" |
| `Credit_Mix` | string | Good, Standard, Poor, Excellent | "Standard" |
| `Payment_of_Min_Amount` | string | Yes, No | "No" |
| `Payment_Behaviour` | string | Padr√µes de comportamento de pagamento | "Low_spent_Medium_value_payments" |

### **Campos Auto-Preenchidos** (Se n√£o fornecidos)

| Campo | Valor Padr√£o | Descri√ß√£o |
|-------|--------------|-----------|
| `Delay_from_due_date` | 0 | Atraso em dias |
| `Num_of_Delayed_Payment` | 0 | N√∫mero de pagamentos atrasados |
| `Changed_Credit_Limit` | 0 | Mudan√ßas no limite de cr√©dito |
| `Num_Credit_Inquiries` | 0 | Consultas de cr√©dito |
| `Month` | "January" | M√™s da an√°lise |
| `Type_of_Loan` | "Personal Loan" | Tipo de empr√©stimo |
| `Credit_History_Age` | "5 Years" | Idade do hist√≥rico de cr√©dito |

## üß™ Exemplos de Uso

### **üî• Exemplo com curl**

```bash
# Usando dados do arquivo data.json
curl -X POST http://localhost:5000/predict \
  -H "Content-Type: application/json" \
  -d @data.json

# Exemplo direto
curl -X POST http://localhost:5000/predict \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "Age": 30,
      "Annual_Income": 50000,
      "Monthly_Inhand_Salary": 4000,
      "Num_Bank_Accounts": 2,
      "Num_Credit_Card": 1,
      "Interest_Rate": 12.0,
      "Num_of_Loan": 1,
      "Outstanding_Debt": 5000,
      "Credit_Utilization_Ratio": 30.0,
      "Total_EMI_per_month": 500,
      "Amount_invested_monthly": 300,
      "Monthly_Balance": 2000
    }
  }'
```

### **üêç Exemplo com Python**

```python
import requests
import json

# Dados do cliente
client_data = {
    "data": {
        "Age": 42,
        "Annual_Income": 80000,
        "Monthly_Inhand_Salary": 6500,
        "Num_Bank_Accounts": 3,
        "Num_Credit_Card": 2,
        "Interest_Rate": 8.5,
        "Num_of_Loan": 1,
        "Outstanding_Debt": 5000,
        "Credit_Utilization_Ratio": 20.0,
        "Total_EMI_per_month": 1200,
        "Amount_invested_monthly": 2000,
        "Monthly_Balance": 4000,
        "Occupation": "Engineer",
        "Credit_Mix": "Good"
    }
}

# Fazer requisi√ß√£o
response = requests.post(
    "http://localhost:5000/predict",
    json=client_data,
    headers={"Content-Type": "application/json"}
)

# Processar resposta
if response.status_code == 200:
    result = response.json()
    print(f"Score: {result['prediction']}")
    print(f"Confian√ßa: {result['confidence']:.2%}")
    print("Probabilidades:")
    for score, prob in result['probabilities'].items():
        print(f"  {score}: {prob:.2%}")
else:
    print(f"Erro: {response.status_code}")
    print(response.json())
```

### **‚ö° Exemplo com JavaScript/Node.js**

```javascript
const axios = require('axios');

async function predictCreditScore() {
    const clientData = {
        data: {
            Age: 28,
            Annual_Income: 45000,
            Monthly_Inhand_Salary: 3600,
            Num_Bank_Accounts: 2,
            Num_Credit_Card: 3,
            Interest_Rate: 15.0,
            Num_of_Loan: 2,
            Outstanding_Debt: 12000,
            Credit_Utilization_Ratio: 45.0,
            Total_EMI_per_month: 800,
            Amount_invested_monthly: 400,
            Monthly_Balance: 1800,
            Occupation: "Analyst",
            Credit_Mix: "Standard"
        }
    };

    try {
        const response = await axios.post(
            'http://localhost:5000/predict',
            clientData,
            { headers: { 'Content-Type': 'application/json' } }
        );
        
        console.log('Score:', response.data.prediction);
        console.log('Confian√ßa:', (response.data.confidence * 100).toFixed(1) + '%');
        console.log('Probabilidades:', response.data.probabilities);
    } catch (error) {
        console.error('Erro:', error.response?.data || error.message);
    }
}

predictCreditScore();
```

## üéØ Cen√°rios de Teste

### **üü¢ Cliente Premium (Score: Good)**
- Alta renda (‚â•$80k)
- Baixa utiliza√ß√£o de cr√©dito (‚â§30%)
- Hist√≥rico de pagamentos pontual
- M√∫ltiplas contas banc√°rias
- Investimentos regulares

### **üü° Cliente M√©dio (Score: Standard)**
- Renda m√©dia ($40k-$80k)
- Utiliza√ß√£o moderada de cr√©dito (30-60%)
- Alguns atrasos ocasionais
- Perfil financeiro equilibrado

### **üî¥ Cliente Alto Risco (Score: Poor)**
- Baixa renda (<$40k)
- Alta utiliza√ß√£o de cr√©dito (‚â•60%)
- M√∫ltiplos atrasos
- Alto endividamento
- Poucos investimentos

## üß™ Sistema de Testes

### **Executar Testes**

```bash
# Todos os testes (Recomendado)
python -m pytest tests/ -v

# Apenas teste espec√≠fico
python -m pytest tests/test_api.py::TestCreditScoreAPI::test_basic_prediction -v

# Demonstra√ß√£o interativa
python demo_api.py
```

### **Testes Inclu√≠dos**

- ‚úÖ **Funcionalidade b√°sica**: Predi√ß√£o com dados v√°lidos
- ‚úÖ **Valida√ß√£o de dados**: Rejei√ß√£o de dados inv√°lidos
- ‚úÖ **Robustez**: Preenchimento autom√°tico de campos
- ‚úÖ **Casos extremos**: Valores m√≠nimos e m√°ximos
- ‚úÖ **Formatos**: API Gateway e invoca√ß√£o direta
- ‚úÖ **Consist√™ncia**: Formato de resposta padronizado
- ‚úÖ **Cen√°rios reais**: Diferentes perfis de clientes
- ‚úÖ **Tratamento de erros**: Handling de exce√ß√µes

## üîß Configura√ß√£o MLflow

### **Modo Autom√°tico (Padr√£o)**
```bash
# API tenta: MLflow ‚Üí Arquivo Local ‚Üí Modelo Mock
python server.py
```

### **Modo MLflow For√ßado**
```bash
# API falha se MLflow n√£o estiver dispon√≠vel
export FORCE_MLFLOW=true
python server.py

# Ou usar script dedicado
python run_api_with_mlflow.py
```

### **Testar Conectividade MLflow**
```bash
python test_mlflow_connection.py
```

## üèóÔ∏è Arquitetura

### **Componentes Principais**

```
üì¶ Credit Score API
‚îú‚îÄ‚îÄ üß† Modelo ML (Random Forest)
‚îú‚îÄ‚îÄ üîÑ Estrat√©gia de Carregamento
‚îÇ   ‚îú‚îÄ‚îÄ 1. MLflow Registry
‚îÇ   ‚îú‚îÄ‚îÄ 2. MLflow Runs
‚îÇ   ‚îú‚îÄ‚îÄ 3. Arquivo Local
‚îÇ   ‚îî‚îÄ‚îÄ 4. Modelo Mock
‚îú‚îÄ‚îÄ üåê Servidor Flask
‚îú‚îÄ‚îÄ üõ°Ô∏è Valida√ß√£o de Dados
‚îú‚îÄ‚îÄ üìä Monitoramento
‚îî‚îÄ‚îÄ üß™ Suite de Testes
```

### **Fluxo de Predi√ß√£o**

```mermaid
graph TD
    A[Cliente] -->|JSON| B[Servidor Flask]
    B --> C[Valida√ß√£o de Dados]
    C --> D[Pr√©-processamento]
    D --> E[Modelo ML]
    E --> F[P√≥s-processamento]
    F --> G[Resposta JSON]
    G --> A
    
    E --> H[M√©tricas]
    E --> I[Logs]
    E --> J[Data Drift]
```

## üìÅ Estrutura do Projeto

```
api/
‚îú‚îÄ‚îÄ üìÅ src/
‚îÇ   ‚îî‚îÄ‚îÄ app.py                 # üéØ L√≥gica principal da API (handler Lambda)
‚îú‚îÄ‚îÄ üìÅ model/                  # üì¶ Modelos baixados do MLflow
‚îÇ   ‚îú‚îÄ‚îÄ model.pkl             # üß† Modelo principal
‚îÇ   ‚îú‚îÄ‚îÄ random_forest_credit_score.pkl
‚îÇ   ‚îú‚îÄ‚îÄ label_encoder.pkl
‚îÇ   ‚îî‚îÄ‚îÄ model_metadata.json   # üìã Metadados do modelo
‚îú‚îÄ‚îÄ üìÅ tests/                  # üß™ Testes organizados
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py           # ‚öôÔ∏è Configura√ß√µes pytest
‚îÇ   ‚îî‚îÄ‚îÄ test_api.py           # ‚úÖ Todos os testes da API
‚îú‚îÄ‚îÄ üìÅ .github/               # üöÄ CI/CD workflows
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îú‚îÄ‚îÄ server.py                 # üåê Servidor Flask HTTP
‚îú‚îÄ‚îÄ demo_api.py               # üé¨ Demonstra√ß√£o interativa
‚îú‚îÄ‚îÄ model_downloader.py       # ‚¨áÔ∏è Download de modelos MLflow
‚îú‚îÄ‚îÄ run_api_with_mlflow.py    # üîí Executar com MLflow obrigat√≥rio
‚îú‚îÄ‚îÄ test_mlflow_connection.py # üîå Testar conectividade MLflow
‚îú‚îÄ‚îÄ data.json                 # üìä Dados de exemplo
‚îú‚îÄ‚îÄ requirements.txt          # üìã Depend√™ncias Python
‚îú‚îÄ‚îÄ Dockerfile                # üê≥ Configura√ß√£o Docker
‚îú‚îÄ‚îÄ .gitignore               # üö´ Arquivos ignorados
‚îî‚îÄ‚îÄ README.md                # üìñ Esta documenta√ß√£o
```

## üîí C√≥digos de Resposta

| C√≥digo | Significado | Descri√ß√£o |
|--------|-------------|-----------|
| **200** | Sucesso | Predi√ß√£o executada com sucesso |
| **400** | Bad Request | Dados de entrada inv√°lidos |
| **500** | Server Error | Erro interno do servidor/modelo |

### **Exemplos de Erro**

**400 - Dados Inv√°lidos:**
```json
{
  "error": "Dados inv√°lidos",
  "message": "Idade deve estar entre 18 e 100 anos"
}
```

**500 - Erro Interno:**
```json
{
  "error": "Erro na predi√ß√£o",
  "message": "Falha ao executar o modelo"
}
```

## üê≥ Deploy com Docker

### **Build e Run**
```bash
# Build da imagem
docker build -t credit-score-api .

# Executar container
docker run -p 5000:8080 credit-score-api

# Com vari√°veis de ambiente
docker run -p 5000:8080 \
  -e FORCE_MLFLOW=true \
  -e AWS_REGION=us-east-1 \
  credit-score-api
```

## üîß Solu√ß√£o de Problemas

### **‚ùì API n√£o sobe na porta**
```bash
# ‚ùå Problema: python src/app.py n√£o sobe servidor
# ‚úÖ Solu√ß√£o: src/app.py √© fun√ß√£o Lambda, use:
python server.py
```

### **‚ùì Erro de MLflow**
```bash
# ‚ùå Problema: Could not find registered artifact repository
# ‚úÖ Solu√ß√µes:
python test_mlflow_connection.py  # Testar conectividade
python model_downloader.py       # Baixar modelo local
export FORCE_MLFLOW=false        # Desabilitar modo for√ßado
```

### **‚ùì Testes falhando**
```bash
# ‚ùå Problema: ImportError ou ModuleNotFoundError
# ‚úÖ Solu√ß√µes:
pip install -r requirements.txt  # Reinstalar depend√™ncias
python -m pytest tests/ -v      # Executar com pytest
```

### **‚ùì Modelo n√£o carrega**
```bash
# ‚úÖ Verifica√ß√µes:
ls model/                        # Verificar arquivos do modelo
python demo_api.py              # Testar funcionamento
python -c "import src.app; print(src.app.model_info)"  # Info do modelo
```

**üÜò Problemas Comuns:**
- Verifique logs: Procure por erros na sa√≠da do `python server.py`
- Teste conectividade: `python test_mlflow_connection.py`
- Execute testes: `python -m pytest tests/ -v`
- Consulte documenta√ß√£o MLflow


